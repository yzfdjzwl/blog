# 目录

* [HTTPS是什么](#https是什么)
* [HTTPS如何加密](#https如何加密)
    * [常见的两种加密方式](#常见的两种加密方式)
* [问题一: 获取公钥的方式](#问题一-获取公钥的方式)
    * [证书](#证书)
    * [CA](#ca)
* [问题二: 数据传输仅单向安全](#问题二-数据传输仅单向安全)
* [流程](#流程)
* [参考](#参考)

## HTTPS是什么

HTTPS在应用层(http)和传输层中间加了一层新的协议(ssl/tsl), 现在一般用的是tsl。

## HTTPS如何加密

### 常见的两种加密方式

* 对称加密: 使用的加密钥匙和解密钥匙是同一个。
* 非对称加密: 加密钥匙和解密钥匙不一样。一般公钥用于加密，私钥用于解密；但是同样私钥也可以用于加密，公钥也可以用于解密(划重点)。

由于私钥也用于加密，公钥也用于解密，但是公钥又是公开的，所以数据传输只能保证单向安全，如何保证双向安全呢？

公钥是公开的，并且公钥又如何获取呢？下面介绍这两个问题。

## 问题一: 获取公钥的方式

这里需要涉及到两个重要的概念: 证书，CA(证书颁发机构)。

### 证书

我们可以把它理解为网站的身份证，它里面包含了很多信息，其中就包含了上面提到的公钥。

简单的流程就是: XX网站向CA提出了申请，CA通过后，将证书颁发给网站，安装在网站的服务器上。当用户访问XX网站的时候，XX网站将证书发给用户。

### CA

CA即证书颁发机构，上面已经提到了。

## 问题二: 数据传输仅单向安全 

这里就用到了对称加密。

## Client与Server协商流程

1. Server拥有私钥，Client拥有公钥。
2. Client向Server发送请求，使用公钥将信息加密。
3. Server获取后，使用私钥对信息进行解密。
4. Server将要回信给Client，这个时候需要解决两个问题。
5. 第一个问题，Client如何知道发送方是Server(数字证书)。
6. 第二个问题，Client知道发送方是Server后，如何确保Server发送的信件没有被修改过(数字签名)。
7. 首先: Server使用hash算法生成信件的摘要(Digit)。
8. 然后: Server将使用私钥对摘要(Digit)进行加密, 生成数字签名。(Signature)
9. 再而: Server将这个签名，附在信件里，一起发送给Client。
10. 最后: Client收到信件，取下数字签名，使用公钥进行解密，由此证明确实是Server发送的。
11. 问题: 但是，Client的公钥可能会被伪造，如何保证公钥是来自Server的，而不是被伪造的 ?
12. 这里: 就涉及到了之前提到的CA和证书了，Client一般都有个证书管理器(重点！)，有"受信任的根证书颁发机构"列表。客户端会根据这个列表，查看解开数字证书的公钥是否在列表内。
13. 接上: 如果数字证书上记载的地址，与你浏览的网址不一致，说明该证书被冒用。
14. 接上: 如果这张数字证书不是由权威CA颁布的，会有另一种提示。
15. 如何确保内容没有被修改过呢? Client会先使用公钥对数字签名进行解密，得到摘要A; 然后使用hash算法得到该信件的摘要B。比对摘要A和摘要B，如果一致，则表示没有被修改过。
16. 重点: 由于公钥是公开的，那么私钥加密的内容公钥都可以解开，这样就不能保证Server到Client的数据是安全的。
17. 接上: 因此TSL又用到了对称加密，当Client访问Server后，会得到证书。得到证书后，拿到里面的公钥A。然后Client生成一个只有自己有的对称密钥BB, 使用公钥A对密钥B进行加密。然后发送给Server。
18. Server收到信件后，使用私钥将信件解密后，拿到Client的对称密钥B，从此之后Client和Server的数据通信都用密钥B进行加密。
19. 注意证书上的基本内容有如下:
    * 证书包含了颁发证书的机构名字CA。
    * 证书内容本身的数字签名(用CA私钥加密)。
    * 证书持有者的公钥。
    * 证书签名所使用的hash算法。

## HTTPS通信过程

0. TCP三次握手。
1. 客户端发送client hello报文开始SSL通信。报文中包含客户端支持的SSL指定的版本等等。
2. 服务端可进行SSL通信时，会以server hello报文回应，报文中含SSL版本加密套件。
3. 之后, 服务端发送certificate(证书)报文，报文中有公开的密钥。
4. 服务端发送server hello done报文通知客户端，最初阶段握手协商部分结束。
5. 客户端验证证书。
6. Client Key Exchange(密钥交换)。
7. 服务端验证密钥交换协商成功后就可以开始传输数据了。


### 总结

1. 数字证书: 用于保证公钥和私钥是安全的, 不会是伪造的, 从中拿到公钥后，以确认服务器的公开密钥的真实性。
2. 数字签名: 用于保证数据的完整性。
3. 对称加密: 用于保证双向数据的安全性。

个人理解，可能不正确，请指出。

## 参考

[最详细的HTTPS科普扫盲贴](https://www.cc362.com/content/kplNK4L41V.html)

[公钥与私钥，HTTPS详解](http://www.cnblogs.com/shijingjing07/p/5965792.html)

[HTTPS研究（2）—分解HTTPS连接建立过程](http://www.jianshu.com/p/a766bbf31417)
